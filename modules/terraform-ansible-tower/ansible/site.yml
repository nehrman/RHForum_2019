- name: Setup Ansible Tower Cluster
  hosts: tower
  any_errors_fatal: true

  tasks:

    - name: Ensure ssh key is present
      copy:
        src: "./.ssh/id_rsa"
        dest: "/root/.ssh/"
        force: yes
        mode: '0400'
      become: true
    
    - name: Ensure ansible.cfg file is present
      copy:
        src: "./.ansible.cfg"
        dest: "/root/"
        force: yes
      become: true

    - name: Enabled Yum Repos
      raw: "sudo yum-config-manager --enable rhui-REGION-rhel-server-extras"
      become: true

    - name: Installed Pre Reqs Packages
      yum:
        name: 
          - ansible 
        state: "present"
      become: true

    - name: Download Ansible Tower 
      unarchive: 
        src: "https://releases.ansible.com/ansible-tower/setup-bundle/ansible-tower-setup-bundle-3.5.3-1.el7.tar.gz"
        dest: "."
        creates: "./ansible-tower-setup-bundle-3.5.3-1.el7"
        remote_src: true
      run_once: yes
    
    - name: import Ansible Tower Configuration
      copy: 
        src: "./inventory"
        dest: "./ansible-tower-setup-bundle-3.5.3-1.el7/inventory"
        force: yes
      run_once: yes
    
    - name: Patch Ansible Tower Roles to make it work on AWS EC2 with rhui
      lineinfile: 
        dest: "./ansible-tower-setup-bundle-3.5.3-1.el7/roles/repos_el/vars/RedHat-7.yml"
        state: present
        regexp: '^    - rhui-REGION-rhel-server-rhscl'
        line: '    - rhel-server-rhui-rhscl-7-rpms'
      run_once: yes
    
    - name: Setup Ansible Tower 
      shell: "./setup.sh"
      args:
        chdir: "./ansible-tower-setup-bundle-3.5.3-1.el7"
      become: true
      run_once: yes

    - name: Waiting for Ansible Tower to become available
      uri:
        url: "https://ip-10-0-10-145.eu-west-3.compute.internal/api/v2/ping"
        validate_certs: "false"
        status_code: "200"
      register: result
      until: result.status == 200
      retries: 60
      delay: 1

    - name: Adding License fo Ansible Tower
      uri:
        url: "https://ip-10-0-10-145.eu-west-3.compute.internal/api/v2/config/"
        user: "admin"
        password: "tower"
        validate_certs: "false"
        force_basic_auth: true
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        method: POST
        body: '{"company_name":"Red Hat","eula_accepted":true,"hostname":"5512b2cf7d364527a6ab7c6077d067fc","instance_count":300,"license_date":1609428347,"license_key":"b4fcfe8747894e65f52b7305333622c64c1d7e9d85ece39d59dd32f1a2011209","license_type":"enterprise","subscription_name":"Red Hat Ansible Tower, Standard (300 Managed Nodes)"}'
        body_format: "json"


